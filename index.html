<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Formul√°rio de Inscri√ß√£o - Jud√¥</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<style>
body {
  margin: 0;
  font-family: 'Arial', sans-serif;
  background-image: url('fundo.png'); /* XXX: sua imagem de fundo */
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  min-height: 100vh;
}
.container {
  max-width: 700px;
  margin: 50px auto;
  padding: 25px;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}
h1,h2 {
  text-align: center;
  font-weight: bold;
  color: #2c3e50;
}
label { font-weight: bold; display: block; margin-top: 15px; }
input, textarea, select {
  width: 100%;
  padding: 12px;
  margin-top: 5px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 14px;
  box-sizing: border-box;
}
input::placeholder, textarea::placeholder { color: #999; font-style: italic; }
button {
  padding: 15px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  color: white;
  margin-top: 20px;
  display: block;
  width: 60%;
  max-width: 300px;
  margin-left: auto;
  margin-right: auto;
}
.btn-blue { background-color: #3498db; }
.btn-blue:hover { background-color: #2980b9; }
.btn-red { background-color: #e74c3c; }
.btn-red:hover { background-color: #c0392b; }
.hidden { display: none; }
#pix { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 15px; cursor: pointer; }
#pix:hover { color: #27ae60; }
.obs-section { margin-top: 10px; text-align: center; }
.file-label {
  display: block;
  border: 2px dashed #3498db;
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  color: #3498db;
  cursor: pointer;
  font-weight: bold;
}
.file-label:hover { background: #ecf0f1; }
select { padding: 10px; border-radius: 8px; border: 1px solid #3498db; background: #fff; font-weight: bold; }
#status { text-align:center; margin-top:10px; color:#c0392b; font-weight:bold; }
</style>
</head>
<body>

<!-- ETAPA 1: QR CODE -->
<div id="tela-inicial" class="container">
  <h1>Pagamento via Pix</h1>
  <img src="qr-code.png" alt="QR Code" style="max-width:200px; margin:20px auto; display:block;">
  <p id="pix">üìã Inserir Pix</p>
  <p style="text-align:center; font-weight:bold; font-size:18px; margin-top:15px;">Valor da inscri√ß√£o: R$ 40,00</p>
  <button id="btn-prosseguir" class="btn-blue">Prosseguir</button>
</div>

<!-- ETAPA 2: FORMUL√ÅRIO -->
<div id="form-container" class="container hidden">
  <h2>Formul√°rio de Inscri√ß√£o</h2>
  <form id="form-inscricao">
    <label>Nome completo</label>
    <input type="text" id="nome" name="nome" placeholder="Digite aqui o nome do aluno" required>

    <label>Data de nascimento</label>
    <input type="date" id="nascimento" name="nascimento" required>

    <label>Peso do aluno (kg)</label>
    <input type="text" id="peso" name="peso" placeholder="Digite seu peso ex: 60 ou 60,00 ou 60.00" required>

    <label>Telefone</label>
    <input type="tel" id="telefone" name="telefone" placeholder="Digite aqui o telefone" required>

    <label>Curso / Evento</label>
    <select id="curso" name="curso" required>
      <option value="" disabled selected>Selecione o curso/evento</option>
      <option>Jud√¥ Iniciante</option>
      <option>Jud√¥ Avan√ßado</option>
      <option>Artes Marciais Gerais</option>
    </select>

    <div class="obs-section">
      <label style="font-weight:bold; font-size:16px;">Observa√ß√£o sobre o aluno(a)</label>
      <div style="display:flex; justify-content:center; gap:40px; margin-top:10px;">
        <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
          <input type="radio" name="observacoes-check" value="N√£o" checked required style="width:18px; height:18px; accent-color:#3498db;"> N√£o
        </label>
        <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
          <input type="radio" name="observacoes-check" value="Sim" style="width:18px; height:18px; accent-color:#e74c3c;"> Sim
        </label>
      </div>
      <textarea id="observacoes" name="observacoes" class="hidden" placeholder="Digite aqui suas observa√ß√µes" style="margin-top:15px;"></textarea>
    </div>

    <label style="display:block; text-align:center; font-weight:bold; font-size:16px; margin-top:20px;">Enviar imagem do comprovante (obrigat√≥rio)</label>
    <label class="file-label" id="file-label">Nenhuma imagem inserida</label>
    <input type="file" id="comprovante" accept="image/*" style="display:none;" required>

    <button type="submit" class="btn-blue">Enviar Inscri√ß√£o</button>
    <div id="status"></div>
  </form>
</div>

<!-- ETAPA 3: CONFIRMA√á√ÉO -->
<div id="second-screen" class="container hidden">
  <h2 style="text-align:center;">‚úÖ Inscri√ß√£o realizada com sucesso ‚úÖ</h2>
  <p style="text-align:center; margin-bottom:20px;">Obrigado por se inscrever!</p>
  <button id="btn-comprovante" class="btn-red" style="display:flex; justify-content:center; align-items:center; gap:8px; font-weight:bold;">üìÑ Baixar Comprovante</button>
</div>

<script>
/* ========== AQUI - sua URL j√° informada ========== */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx2QZslxsS0Egzu0pgBCLM0BdlgIr8m5aDIypIyh0otdpOd_9D7NX-5LGnMS4Fmjg/exec";
/* ================================================= */

const telaInicial = document.getElementById('tela-inicial');
const btnProsseguir = document.getElementById('btn-prosseguir');
const pixEl = document.getElementById('pix');
const formContainer = document.getElementById('form-container');
const form = document.getElementById('form-inscricao');
const statusEl = document.getElementById('status');
const btnEnviar = document.querySelector('#form-inscricao button[type="submit"]');
const secondScreen = document.getElementById('second-screen');
const btnComprovante = document.getElementById('btn-comprovante');
const obsRadios = document.getElementsByName('observacoes-check');
const obsTextarea = document.getElementById('observacoes');
const fileInput = document.getElementById('comprovante');
const fileLabel = document.getElementById('file-label');

let ultimaInscricao = null;
let imagemComprovante = null;

/* Copiar s√≥ Inserir Pix */
pixEl.addEventListener('click', () => {
  navigator.clipboard.writeText("Inserir Pix")
    .then(() => alert('Pix copiado para a √°rea de transfer√™ncia!'))
    .catch(() => alert('N√£o foi poss√≠vel copiar o Pix.'));
});

btnProsseguir.addEventListener('click', () => {
  telaInicial.classList.add('hidden');
  formContainer.classList.remove('hidden');
});

/* Observa√ß√µes condicional */
obsRadios.forEach(radio => {
  radio.addEventListener('change', () => {
    if(radio.value === 'Sim' && radio.checked){
      obsTextarea.classList.remove('hidden');
      obsTextarea.required = true;
    } else {
      obsTextarea.classList.add('hidden');
      obsTextarea.required = false;
      obsTextarea.value = '';
    }
  });
});

/* Upload imagem */
fileLabel.addEventListener('click',()=>fileInput.click());
fileInput.addEventListener('change',(e)=>{
  const file = e.target.files[0];
  if(file){
    imagemComprovante = null;
    const reader = new FileReader();
    reader.onload = () => { imagemComprovante = reader.result; fileLabel.textContent=file.name; }
    reader.readAsDataURL(file);
  } else { fileLabel.textContent='Nenhuma imagem inserida'; }
});

/* Normaliza e formata peso:
   aceita 60  60,00  60.00  -> retorna "60.00" (string) ou '' se inv√°lido
*/
function normalizePeso(raw){
  if(!raw && raw !== 0) return '';
  let s = String(raw).trim();
  s = s.replace(',', '.');          // aceita v√≠rgula
  // remove espa√ßos e eventuais caracteres n√£o numericos exceto ponto
  s = s.replace(/[^\d.]/g,'');
  if(s === '') return '';
  if(isNaN(s)) return '';
  const n = parseFloat(s);
  if(isNaN(n)) return '';
  return n.toFixed(2);
}

/* Coletar dados do formul√°rio - mant√©m seu comportamento original */
function getFormDataObject(){
  const formData = new FormData(form);
  let obs = formData.get('observacoes-check');
  if(obs === 'Sim') obs = formData.get('observacoes');
  const pesoNormalizado = normalizePeso(formData.get('peso') || '');

  return {
    nome: formData.get('nome'),
    nascimento: formData.get('nascimento'),
    peso: pesoNormalizado,
    telefone: formData.get('telefone'),
    curso: formData.get('curso'),
    valor: "R$ 40,00",
    observacoes: obs,
    imagem: imagemComprovante
  };
}

/* Envio robusto: tenta verificar WebApp, envia FormData; se falhar tentamos JSON como fallback.
   Mensagens de erro s√£o colocadas em #status para facilitar debug.
*/
async function enviarParaPlanilha(dataObj){
  // check if file protocol (common dev issue)
  if(location.protocol === 'file:'){
    throw new Error('Abra este arquivo via servidor (Live Server ou http://), n√£o via file:// ‚Äî fetch frequentemente falha em file://.');
  }

  statusEl.textContent = 'Verificando conex√£o com o WebApp...';
  try {
    // teste GET simples (doGet deve responder "OK" no seu Apps Script)
    const test = await fetch(WEB_APP_URL, { method: 'GET', cache: 'no-store' });
    if(!test.ok){
      throw new Error('WebApp inacess√≠vel (GET retornou ' + test.status + '). Verifique deploy e permiss√£o "Qualquer pessoa, mesmo an√¥nima".');
    }
  } catch(err){
    throw new Error('Falha ao conectar ao WebApp (GET). ' + err.message);
  }

  statusEl.textContent = 'Enviando dados para a planilha...';

  // tentativa principal: enviar como FormData multipart (evita preflight)
  const fd = new FormData();
  for(const [k,v] of Object.entries(dataObj)) fd.append(k, v ?? '');

  try {
    const resp = await fetch(WEB_APP_URL, { method: 'POST', body: fd });
    if(!resp.ok){
      const txt = await resp.text().catch(()=>null);
      // tenta interpretar JSON de resposta
      let j = null;
      try { j = await resp.json(); } catch(e){}
      if(j && j.ok === false){
        throw new Error('WebApp retornou erro: ' + (j.error || JSON.stringify(j)));
      }
      throw new Error('WebApp retornou status ' + resp.status + (txt ? (': '+txt) : ''));
    }
    // tudo OK
    statusEl.textContent = '';
    const j = await resp.json().catch(()=>null);
    return j;
  } catch(errFormData){
    // fallback: tentar enviar JSON (pode causar preflight em alguns navegadores)
    console.warn('FormData POST falhou, tentando JSON POST. Erro:', errFormData);
    statusEl.textContent = 'Tentando m√©todo alternativo (JSON)...';
    try {
      const resp2 = await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(dataObj)
      });
      if(!resp2.ok){
        const txt2 = await resp2.text().catch(()=>null);
        throw new Error('JSON POST retornou status ' + resp2.status + (txt2?(': '+txt2):''));
      }
      statusEl.textContent = '';
      const j2 = await resp2.json().catch(()=>null);
      return j2;
    } catch(errJson){
      // ambos falharam -> fornecer mensagem √∫til
      console.error('Erro FormData:', errFormData);
      console.error('Erro JSON:', errJson);
      throw new Error('Falha ao enviar dados para o WebApp. Verifique: URL, deploy (qualquer pessoa mesmo an√¥nima), abrir via servidor (n√£o file://) e se o Apps Script est√° ativo. Detalhes: ' + errJson.message);
    }
  }
}

/* Gerar PDF (mantido igual) */
function gerarPDFComprovante(data){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // XXX -> cole aqui a Base64 da imagem fundo.png (sem espa√ßos)
  doc.addImage("data:image/png;base64,XXX", "PNG", 0, 0, 210, 297);

  doc.setFontSize(20);
  doc.setFont("helvetica", "bold");
  doc.text(`COMPROVANTE DE INSCRI√á√ÉO`, 105, 50, {align:"center"});

  doc.setFontSize(16);
  doc.setFont("helvetica", "normal");
  doc.text(data.curso || "", 105, 60, {align:"center"});

  const texto = `
Nome: ${data.nome || ""}
Data de Nascimento: ${data.nascimento || ""}
Peso: ${data.peso || ""}
Telefone: ${data.telefone || ""}
Curso: ${data.curso || ""}
Valor: ${data.valor || ""}
Observa√ß√µes: ${data.observacoes || ""}
Data: ${new Date().toLocaleDateString("pt-BR")}
`;
  const linhas = texto.split("\n");
  let y = 80;
  linhas.forEach(linha=>{
    if(linha.trim() !== "") {
      doc.text(linha, 20, y, {align:"left"});
      y+=10;
    }
  });

  if(data.imagem){
    try {
      doc.addImage(data.imagem, "JPEG", 80, y+10, 50, 50);
    } catch(e){
      // se a imagem for muito grande ou formato estranho, ignoramos para n√£o quebrar o PDF
      console.warn('Falha ao adicionar imagem ao PDF:', e);
    }
  }

  doc.save(`Comprovante-${(data.nome||'inscricao').replace(/\s+/g,'_')}.pdf`);
}

/* Confete por 3 segundos */
function iniciarConfeteTemporario(){
  const dur = 3*1000;
  const end = Date.now() + dur;
  (function frame(){
    confetti({ particleCount:3, angle:60, spread:55, origin:{x:0} });
    confetti({ particleCount:3, angle:120, spread:55, origin:{x:1} });
    if(Date.now() < end) requestAnimationFrame(frame);
  })();
}

/* Submit do formul√°rio (mant√©m fluxo visual) */
form.addEventListener('submit', async(e)=>{
  e.preventDefault();
  statusEl.textContent='';
  try{
    btnEnviar.disabled=true;
    statusEl.textContent='Enviando...';
    const dataObj = getFormDataObject();

    // valida√ß√µes r√°pidas
    if(!dataObj.nome || !dataObj.nascimento || !dataObj.peso){
      throw new Error('Preencha nome, data de nascimento e peso corretamente.');
    }

    // enviar para planilha (robusto)
    await enviarParaPlanilha(dataObj);

    // sucesso local
    ultimaInscricao=dataObj;
    formContainer.classList.add('hidden');
    secondScreen.classList.remove('hidden');
    iniciarConfeteTemporario();
  } catch(err){
    statusEl.textContent='Erro: '+(err.message||err);
    console.error(err);
  } finally{
    btnEnviar.disabled=false;
  }
});

/* Baixar PDF */
btnComprovante.addEventListener('click',()=>{
  if(!ultimaInscricao){ alert("Preencha e envie o formul√°rio primeiro."); return; }
  gerarPDFComprovante(ultimaInscricao);
});
</script>
</body>
</html>
